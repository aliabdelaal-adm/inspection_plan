<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>خطة التفتيش الشهرية</title>
  <style>
    body { font-family:'Segoe UI',Arial,sans-serif; background:#f6f6f6; margin:0; padding:0;}
    .container { max-width:950px; margin:40px auto; background:#fff; border-radius:10px; box-shadow:0 0 10px #bbb; padding:28px; direction:rtl;}
    .header { background:#2336a0; color:#fff; font-size:1.6em; text-align:center; padding:16px 0; border-radius:8px; margin-bottom:24px;}
    .section-title { background:#e2e6f6; font-size:1.17em; font-weight:bold; margin:22px 0 10px 0; padding:7px 0; border-radius:6px; text-align:right;}
    .section-title.red { color:#c00; }
    .between-tables-space {height:40px;}
    .copyright { text-align:center; color:#2336a0; font-weight:bold; margin-top:30px; font-size:1.1em;}
    .admin-section { background:#e2e6f6; border-radius:6px; padding:10px; margin-bottom:24px; }
    .list-item {display:inline-block; background:#2336a0; color:#fff; margin:2px; padding:4px 12px; border-radius:4px;}
    .del-btn {background:#c00; color:#fff; border:none; border-radius:50%; width:20px; height:20px; margin-right:7px; cursor:pointer;}
    .del-btn:hover {background:#a00;}
    .add-box {display:inline-block; margin-right:12px;}
    table {width:100%; border-collapse:collapse; background:#fafafa;}
    th,td {border:1px solid #bbb; padding:12px 6px; text-align:center; vertical-align:middle; font-size:1.09em;}
    th {background:#2336a0; color:#fff;}
    .goals-cell { text-align:right; background:#f3f7ff; color:#2336a0; font-weight:bold; font-size:1.09em;}
    .goals-red { color:#c00; font-weight:bold; }
    .goals-edit-label { font-size:1.12em; color:#2336a0; font-weight:bold; }
    .goals-edit-text {width:98%; padding:7px; font-size:1.09em; border-radius:6px; border:1px solid #bbb; background:#f3f7ff; color:#2336a0;}
    .stats-table {margin:16px auto 24px auto; border:1px solid #2336a0; border-radius:8px; background:#f7f7ff;}
    .stats-table th {background:#2336a0; color:#fff;}
    .stats-table td {background:#fff;}
    .stats-table tfoot td {background:#e2e6f6; font-weight:bold;}
    .stats-inspector-col {min-width:160px; width:160px;}
    .stats-total-cell { color:#c00; font-weight:bold;}
    .print-btn, .save-btn { background:#2336a0; color:#fff; border:none; border-radius:4px; padding:8px 22px; font-size:1em; cursor:pointer; margin-bottom:12px; }
    .print-btn:hover, .save-btn:hover { background:#2a43c7; }
    .pw-popup { position: fixed; top: 0; right: 0; left:0; bottom:0; background: rgba(0,0,0,0.12); display: flex; align-items:center; justify-content:center; z-index:1000;}
    .pw-box { background:#fff; padding:30px 24px; border-radius:12px; box-shadow:0 6px 30px #aaa; min-width:320px; text-align:center;}
    .pw-box label { font-size:1.1em; color:#2336a0;}
    .pw-box input[type="password"], .pw-box input[type="text"] { font-size:1.1em; padding:7px; margin:12px 0; border:1px solid #ccc; border-radius:6px; width:96%;}
    .pw-box button { background:#2336a0; color:#fff; padding:9px 32px; font-size:1.1em; border-radius:8px; border:none; cursor:pointer; margin:0 4px;}
    .pw-box button:hover { background:#2a43c7;}
    .pw-error {color:#c00; margin-top:10px; font-weight:bold;}
    .goals-edit-box {margin: 14px 0 14px 0;}
    .update-banner {background: #c00; color: #fff; font-weight: bold; text-align: center; padding: 12px 0; border-radius: 7px; margin-bottom: 18px; font-size: 1.13em;}
    /* Popup shops */
    .shops-popup-bg {position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.15);z-index:2000;display:flex;align-items:center;justify-content:center;}
    .shops-popup-box {background:#fff;padding:24px 18px;border-radius:10px;box-shadow:0 5px 32px #aaa;min-width:320px;max-width:420px;text-align:right;}
    .shops-popup-box strong {color:#2336a0;}
    .shops-popup-btn {background:#2336a0;color:#fff;border:none;border-radius:4px;padding:7px 16px;font-size:1em;cursor:pointer;}
    .shops-popup-btn:hover {background:#2a43c7;}
    .shop-list-popup-bg {position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.13);z-index:2200;display:flex;align-items:center;justify-content:center;}
    .shop-list-popup {text-align:right; padding:18px; background:#fff; border-radius:10px; box-shadow:0 4px 20px #aaa; min-width:220px;}
    .shop-list-popup ul {list-style:none; padding:0; margin:0;}
    .shop-list-popup ul li {padding:7px 0; border-bottom:1px solid #eee; color:#2336a0;}
    .shop-list-popup-close {background:#c00; color:#fff; border:none; border-radius:4px; padding:4px 14px; font-size:1em; cursor:pointer; margin-top:10px;}
    .shop-list-popup-close:hover {background:#a00;}
    .shops-cell-btn {background:#e2e6f6; color:#2336a0; border:none; border-radius:4px; padding:6px 17px; font-size:1em; cursor:pointer;}
    .shops-cell-btn:hover {background:#bed3fa;}
    @media print { .print-btn, .copyright, .admin-section, .save-btn, .pw-popup, .shops-popup-bg, .stats-table, .shop-list-popup-bg, .update-banner { display:none !important;} body { background:#fff; } .container{ box-shadow:none;} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">خطة التفتيش الشهرية</div>
    <div id="updateBanner" class="update-banner" style="display:none;">
      يوجد تحديث جديد في خطة التفتيش &mdash; <button onclick="reloadPlan(true)" style="font-weight:bold; background:#fff; color:#c00; border-radius:5px; border:none; padding:3px 12px; margin-right:10px; cursor:pointer;">عرض الخطة الجديدة</button>
    </div>
    <div style="text-align:left; margin-bottom:12px;">
      <label>نوع المستخدم: </label>
      <select id="userType" onchange="onUserTypeChange()">
        <option value="inspector">مفتش</option>
        <option value="developer">المطور</option>
      </select>
    </div>
    <div id="pwPopup" class="pw-popup" style="display:none;">
      <div class="pw-box">
        <label>أدخل كلمة المرور للمطور:</label><br>
        <input id="pwInput" type="password" autocomplete="off" onkeypress="if(event.key==='Enter'){checkPassword();}">
        <br>
        <button onclick="checkPassword()">دخول</button>
        <button onclick="cancelPassword()">إلغاء</button>
        <div id="pwError" class="pw-error"></div>
      </div>
    </div>
    <div id="adminSection" class="admin-section" style="display:none;">
      <strong>إدارة المفتشين:</strong>
      <div id="inspectors"></div>
      <div class="add-box">
        <input id="newInspector" type="text" placeholder="اسم مفتش جديد">
        <button onclick="addInspector()">إضافة مفتش</button>
      </div>
      <hr>
      <strong>إدارة المناطق:</strong>
      <div id="areas"></div>
      <div class="add-box">
        <input id="newArea" type="text" placeholder="منطقة جديدة">
        <button onclick="addArea()">إضافة منطقة</button>
      </div>
      <hr>
      <strong>إدارة المحلات حسب المنطقة:</strong>
      <div id="shops"></div>
      <div class="add-box">
        <select id="shopArea"></select>
        <input id="newShop" type="text" placeholder="اسم محل جديد">
        <button onclick="addShop()">إضافة محل</button>
      </div>
      <hr>
      <strong>إدارة خطة التفتيش:</strong>
      <div id="distribution"></div>
      <button class="save-btn" onclick="savePlan()">حفظ الخطة على GitHub</button>
      <button class="save-btn" onclick="savePlanLocally()">حفظ الخطة على الجهاز</button>
      <button class="save-btn" style="background:#2a43c7" onclick="reloadPlan(true)">تحديث الخطة من GitHub</button>
      <hr>
      <strong class="goals-edit-label">أهداف التفتيش هذا الشهر:</strong>
      <div class="goals-edit-box">
        <textarea id="goalsEdit" class="goals-edit-text" rows="3"></textarea><br>
        <button class="goals-save-btn" onclick="saveGoals()">حفظ الأهداف</button>
      </div>
    </div>
    <button class="print-btn" onclick="window.print()">طباعة أو حفظ PDF</button>
    <div class="section-title red">جدول التفتيش</div>
    <div id="planTable"></div>
    <div class="between-tables-space"></div>
    <div class="section-title red">احصائيات التفتيش</div>
    <div id="stats"></div>
    <div class="copyright">
      جميع الحقوق محفوظة &copy; المطور د. علي عبدالعال
    </div>
    <div id="shopsPopup" style="display:none;"></div>
    <div id="shopListPopupBg" class="shop-list-popup-bg" style="display:none;">
      <div id="shopListPopup" class="shop-list-popup"></div>
    </div>
  </div>
  <script>
    // إعدادات المستودع
    const PLAN_REPO = "aliabdelaal-adm/Monthly_inspection_plan";
    const PLAN_FILE = "plan-data.json";
    const PLAN_BRANCH = "main";
    const DEVELOPER_PASSWORD = "ali@1983!!!";
    const TOKEN_KEY = "devGitHubToken";
    let isDevAuthorized = false;
    let lastPlanSha = "";
    let planData = null;
    let prevPlanSha = localStorage.getItem("planPlanSha") || "";

    // جلب الخطة من GitHub بدون كاش
    async function fetchPlanFromGitHub(showBannerIfNew=true) {
      let url = `https://raw.githubusercontent.com/${PLAN_REPO.split("/")[0]}/${PLAN_REPO.split("/")[1]}/${PLAN_BRANCH}/${PLAN_FILE}?t=${Date.now()}`;
      let apiUrl = `https://api.github.com/repos/${PLAN_REPO}/contents/${PLAN_FILE}?ref=${PLAN_BRANCH}&t=${Date.now()}`;
      // 1- جلب sha أولاً (للتحقق من التحديثات)
      let shaResp = await fetch(apiUrl, {cache:"reload"});
      if (!shaResp.ok) throw new Error("تعذر جلب بيانات الملف من GitHub");
      let shaData = await shaResp.json();
      let remoteSha = shaData.sha;
      if (lastPlanSha && lastPlanSha !== remoteSha && showBannerIfNew) {
        document.getElementById("updateBanner").style.display = "block";
        return null;
      }
      // 2- جلب البيانات الفعلية
      let resp = await fetch(url, {cache:"reload"});
      if (!resp.ok) throw new Error("تعذر جلب خطة التفتيش من GitHub");
      let data = await resp.json();
      lastPlanSha = remoteSha;
      localStorage.setItem("planPlanSha", remoteSha);
      document.getElementById("updateBanner").style.display = "none";
      return data;
    }

    // إعادة تحميل الخطة (مع إجبار التحديث)
    async function reloadPlan(force=false) {
      document.getElementById("updateBanner").style.display = "none";
      let data = await fetchPlanFromGitHub(false);
      if (data) {
        planData = data;
        renderAll();
        alert("تم تحميل آخر نسخة من الخطة من GitHub.");
      } else if(force) {
        // في حال لم تتغير sha عد تحميل البيانات
        let url = `https://raw.githubusercontent.com/${PLAN_REPO.split("/")[0]}/${PLAN_REPO.split("/")[1]}/${PLAN_BRANCH}/${PLAN_FILE}?t=${Date.now()}`;
        let resp = await fetch(url, {cache:"reload"});
        if (resp.ok) {
          planData = await resp.json();
          renderAll();
          alert("تم تحميل آخر نسخة من الخطة من GitHub.");
        }
      }
    }

    // المراقبة الدورية للتحديث
    setInterval(async () => {
      try {
        let apiUrl = `https://api.github.com/repos/${PLAN_REPO}/contents/${PLAN_FILE}?ref=${PLAN_BRANCH}&t=${Date.now()}`;
        let shaResp = await fetch(apiUrl, {cache:"reload"});
        if (!shaResp.ok) return;
        let shaData = await shaResp.json();
        let remoteSha = shaData.sha;
        if (lastPlanSha && remoteSha !== lastPlanSha) {
          document.getElementById("updateBanner").style.display = "block";
        }
      } catch(e){}
    }, 60000); // كل دقيقة

    // تحميل الخطة عند بدء الصفحة
    window.onload = async function() {
      try {
        planData = await fetchPlanFromGitHub();
        if (!planData) {
          // إذا كانت هناك نسخة محلية محفوظة (مطور فقط)
          let backup = localStorage.getItem("planDataBackup");
          if (backup) planData = JSON.parse(backup);
        }
        renderAll();
      } catch(e){
        alert("تعذر تحميل خطة التفتيش من GitHub.\n" + e.message);
      }
    };

    // عرض كل أجزاء الصفحة
    function renderAll() {
      renderPlanTable();
      renderStats();
      if(isDevAuthorized) {
        renderInspectors();
        renderAreas();
        renderShops();
        renderShopAreaSelect();
        renderDistribution();
        document.getElementById("goalsEdit").value = planData.goals || "";
      }
    }

    // واجهة المستخدم ـ مفتش/مطور
    function onUserTypeChange() {
      let userType = document.getElementById("userType").value;
      if(userType==="developer" && !isDevAuthorized) {
        document.getElementById("pwPopup").style.display = "flex";
        document.getElementById("pwInput").value = "";
        document.getElementById("pwInput").focus();
        document.getElementById("pwError").textContent = "";
        document.getElementById("adminSection").style.display = "none";
      } else if(userType==="developer" && isDevAuthorized) {
        document.getElementById("adminSection").style.display = "block";
        document.getElementById("goalsEdit").value = planData.goals || "";
      } else {
        document.getElementById("adminSection").style.display = "none";
      }
      renderAll();
    }
    function checkPassword() {
      let pw = document.getElementById("pwInput").value;
      if(pw === DEVELOPER_PASSWORD) {
        isDevAuthorized = true;
        document.getElementById("pwPopup").style.display = "none";
        document.getElementById("adminSection").style.display = "block";
        document.getElementById("goalsEdit").value = planData.goals || "";
        renderAll();
        // في أول دخول للمطور: يطلب التوكن إذا لم يكن مخزن
        setTimeout(askTokenIfNeeded, 500);
      } else {
        document.getElementById("pwError").textContent = "كلمة المرور غير صحيحة!";
        document.getElementById("pwInput").focus();
      }
    }
    function cancelPassword() {
      document.getElementById("pwPopup").style.display = "none";
      document.getElementById("userType").value = "inspector";
      document.getElementById("adminSection").style.display = "none";
      isDevAuthorized = false;
      renderAll();
    }

    // طلب التوكن مرة واحدة فقط
    function askTokenIfNeeded() {
      if(!localStorage.getItem(TOKEN_KEY)) {
        let t = prompt("أدخل GitHub Personal Access Token (مرة واحدة فقط):\n(يفضل أن يكون له صلاحية repo:public_repo)");
        if(t) localStorage.setItem(TOKEN_KEY, t.trim());
      }
    }
    function getTokenOrAsk() {
      let t = localStorage.getItem(TOKEN_KEY);
      if(!t) askTokenIfNeeded();
      return localStorage.getItem(TOKEN_KEY);
    }

    // إدارة المفتشين
    function renderInspectors() {
      let html = "";
      (planData.inspectors||[]).forEach((inspector, i) => {
        html += `<span class="list-item">${inspector} <button class="del-btn" onclick="delInspector(${i})">×</button></span>`;
      });
      document.getElementById("inspectors").innerHTML = html;
    }
    function addInspector() {
      let val = document.getElementById("newInspector").value.trim();
      if(val && !planData.inspectors.includes(val)) {
        planData.inspectors.push(val);
        renderInspectors();
        renderDistribution();
        renderPlanTable();
        renderStats();
      }
    }
    function delInspector(i) {
      planData.inspectors.splice(i,1);
      renderInspectors();
      renderDistribution();
      renderPlanTable();
      renderStats();
    }

    // إدارة المناطق
    function renderAreas() {
      let html = "";
      (planData.areas||[]).forEach((area, i) => {
        html += `<span class="list-item">${area} <button class="del-btn" onclick="delArea(${i})">×</button></span>`;
      });
      document.getElementById("areas").innerHTML = html;
      renderShopAreaSelect();
    }
    function addArea() {
      let val = document.getElementById("newArea").value.trim();
      if(val && !planData.areas.includes(val)) {
        planData.areas.push(val); planData.shopsByArea[val]=[];
        renderAreas(); renderShops(); renderShopAreaSelect();
      }
    }
    function delArea(i) {
      let area = planData.areas[i];
      planData.areas.splice(i,1);
      delete planData.shopsByArea[area];
      renderAreas(); renderShops(); renderShopAreaSelect();
    }

    // إدارة المحلات
    function renderShopAreaSelect() {
      let sel = document.getElementById("shopArea");
      sel.innerHTML = "";
      (planData.areas||[]).forEach(area => {
        let opt = document.createElement("option");
        opt.value = area; opt.textContent = area;
        sel.appendChild(opt);
      });
    }
    function renderShops() {
      let html = "";
      (planData.areas||[]).forEach(area => {
        html += `<strong>${area}:</strong> `;
        (planData.shopsByArea[area]||[]).forEach((shop,i) => {
          html += `<span class="list-item">${shop} <button class="del-btn" onclick="delShop('${area}',${i})">×</button></span>`;
        });
        html += "<br>";
      });
      document.getElementById("shops").innerHTML = html;
    }
    function addShop() {
      let area = document.getElementById("shopArea").value;
      let shop = document.getElementById("newShop").value.trim();
      if(area && shop && !planData.shopsByArea[area].includes(shop)) {
        planData.shopsByArea[area].push(shop);
        renderShops();
        document.getElementById("newShop").value = "";
        planData.distribution.forEach((row,i)=>{
          if(row.area === area) row.shops = [...planData.shopsByArea[area]];
        });
        renderDistribution();
        renderPlanTable();
        renderStats();
      }
    }
    function delShop(area,i) {
      planData.shopsByArea[area].splice(i,1);
      renderShops();
      planData.distribution.forEach((row)=>{
        if(row.area === area) row.shops = row.shops.filter(shop => planData.shopsByArea[area].includes(shop));
      });
      renderDistribution();
      renderPlanTable();
      renderStats();
    }

    // إدارة جدول التوزيع
    function renderDistribution() {
      let userType = document.getElementById("userType").value;
      let html = `<table><tr>
        <th>مفتش</th>
        <th>اليوم</th>
        <th>وقت المناوبة</th>
        <th>المنطقة</th>
        <th>المحلات</th>
        <th>حذف</th>
      </tr>`;
      (planData.distribution||[]).forEach((row,i) => {
        html += `<tr>
          <td>$$
            (userType === "developer" && isDevAuthorized)
              ? \\`<select onchange="updateDist(${i},'inspector',this.value)">
                  $$(planData.inspectors||[]).map(ins => `\<option${row.inspector===ins?" selected":""}>${ins}</option>`).join("")
                </select>`
              : row.inspector
          </td>
          <td><input type="date" value="${row.day}" onchange="updateDist(${i},'day',this.value)"></td>
          <td>$$
            (userType === "developer" && isDevAuthorized)
              ? \\`<select onchange="updateDist(${i},'shift',this.value)">
                  <option${row.shift==="صباحية"?" selected":""}>صباحية</option>
                  <option${row.shift==="مسائية"?" selected":""}>مسائية</option>
                </select>`
              : (row.shift || "")
          </td>
          <td><select onchange="updateDist(${i},'area',this.value)">${(planData.areas||[]).map(ar => `<option${row.area===ar?" selected":""}>${ar}</option>`).join("")}</select></td>
          <td><button class="shops-cell-btn" onclick="showShopListPopup(${i})">عرض المحلات</button>
              $$
                (userType === "developer" && isDevAuthorized)
                  ? \\`<button class="shops-cell-btn" style="background:#bed3fa;" onclick="openShopsPopup(${i})">تعديل المحلات</button>`
                  : ""
              }
          </td>
          <td><button class="del-btn" onclick="delDistRow(${i})">×</button></td>
        </tr>`;
      });
      html += `</table><button onclick="addDistRow()">إضافة صف</button>`;
      document.getElementById("distribution").innerHTML = html;
    }
    function addDistRow() {
      planData.distribution.push({inspector:planData.inspectors[0]||"", day:"", shift:"صباحية", area:planData.areas[0]||"", shops:[...(planData.shopsByArea[planData.areas[0]]||[])]});
      renderDistribution();
      renderPlanTable();
      renderStats();
    }
    function updateDist(i, field, value) {
      planData.distribution[i][field]=value;
      if(field==="area") {
        planData.distribution[i].shops = [...(planData.shopsByArea[value]||[])];
      }
      renderDistribution();
      renderPlanTable();
      renderStats();
    }
    function delDistRow(i) {
      planData.distribution.splice(i,1);
      renderDistribution();
      renderPlanTable();
      renderStats();
    }

    // إدارة المحلات في صف التوزيع
    function openShopsPopup(distIndex) {
      let userType = document.getElementById("userType").value;
      let isReadonly = (userType !== "developer" || !isDevAuthorized);
      let dist = planData.distribution[distIndex];
      let area = dist.area;
      let shops = planData.shopsByArea[area] || [];
      let selectedShops = dist.shops || [];
      let popup = document.getElementById("shopsPopup");
      let html = `<div class="shops-popup-bg" onclick="closeShopsPopup(event)">
        <div class="shops-popup-box" onclick="event.stopPropagation()">
          <strong>اختيار المحلات من منطقة (${area}):</strong><br><br>
          <form id="shopsForm">`;
      shops.forEach(shop => {
        let checked = selectedShops.includes(shop) ? "checked" : "";
        html += `<label style="display:block;margin-bottom:7px;">
          <input type="checkbox" value="${shop}" ${checked} ${isReadonly ? "disabled" : ""}> ${shop}
        </label>`;
      });
      html += `<br>`;
      if(!isReadonly)
        html += `<button type="button" class="shops-popup-btn" onclick="saveShopsPopup(${distIndex})">حفظ</button>`;
      html += `<button type="button" class="shops-popup-btn" onclick="closeShopsPopup()">إغلاق</button>
          </form>
          </div>
        </div>`;
      popup.innerHTML = html;
      popup.style.display = "block";
    }
    function closeShopsPopup(e) {
      if(e && e.target !== document.getElementById("shopsPopup")) return;
      document.getElementById("shopsPopup").style.display = "none";
    }
    function saveShopsPopup(distIndex) {
      let form = document.getElementById("shopsForm");
      let checkedShops = Array.from(form.querySelectorAll('input[type="checkbox":checked]')).map(chk => chk.value);
      planData.distribution[distIndex].shops = checkedShops;
      document.getElementById("shopsPopup").style.display = "none";
      renderDistribution();
      renderPlanTable();
      renderStats();
    }
    window.onclick = function(e){
      let popup = document.getElementById("shopsPopup");
      if(popup.style.display==="block" && e.target === popup) popup.style.display = "none";
    }
    function showShopListPopup(distIndex) {
      let dist = planData.distribution[distIndex];
      let shops = dist.shops || [];
      let bg = document.getElementById("shopListPopupBg");
      let popup = document.getElementById("shopListPopup");
      let html = `<strong>المحلات المرجو تفتيشها:</strong><ul>`;
      if(shops.length) {
        shops.forEach(shop => {
          html += `<li>${shop}</li>`;
        });
      } else {
        html += `<li style="color:#c00;">لا توجد محلات محددة</li>`;
      }
      html += `</ul><button class="shop-list-popup-close" onclick="closeShopListPopup()">إغلاق</button>`;
      popup.innerHTML = html;
      bg.style.display = "flex";
    }
    function closeShopListPopup() {
      document.getElementById("shopListPopupBg").style.display = "none";
    }

    // جدول الاحصائيات
    function renderStats() {
      let inspectorShopCounts = {};
      let morningCounts = {};
      let eveningCounts = {};
      let weekendCounts = {};
      (planData.inspectors||[]).forEach(inspector => {
        inspectorShopCounts[inspector] = 0;
        morningCounts[inspector] = 0;
        eveningCounts[inspector] = 0;
        weekendCounts[inspector] = 0;
      });
      (planData.distribution||[]).forEach(row => {
        if (!row.inspector || !planData.inspectors.includes(row.inspector)) return;
        let shopsCount = row.shops ? row.shops.length : 0;
        let shift = row.shift || "";
        let inspector = row.inspector;
        let dayStr = row.day;
        let isWeekend = false;
        if (dayStr) {
          let d = new Date(dayStr);
          let dayOfWeek = d.getDay();
          if (dayOfWeek === 5 || dayOfWeek === 6 || dayOfWeek === 0) isWeekend = true;
        }
        inspectorShopCounts[inspector] += shopsCount;
        if (shift === "صباحية") morningCounts[inspector] += shopsCount;
        if (shift === "مسائية") eveningCounts[inspector] += shopsCount;
        if (isWeekend) weekendCounts[inspector] += shopsCount;
      });
      let html = `<table class="stats-table">
        <thead>
          <tr>
            <th class="stats-inspector-col">اسم المفتش</th>
            <th>عدد التفتيشات (كل الشهر)</th>
            <th>عدد التفتيشات الصباحية</th>
            <th>عدد التفتيشات المسائية</th>
            <th>عدد التفتيشات في العطلة (جمعة/سبت/أحد)</th>
          </tr>
        </thead>
        <tbody>`;
      (planData.inspectors||[]).forEach(name => {
        html += `<tr>
          <td class="stats-inspector-col">${name}</td>
          <td>${inspectorShopCounts[name]}</td>
          <td>${morningCounts[name]}</td>
          <td>${eveningCounts[name]}</td>
          <td>${weekendCounts[name]}</td>
        </tr>`;
      });
      html += `</tbody>
        <tfoot>
          <tr>
            <td class="stats-total-cell">مجموع التفتيش</td>
            <td class="stats-total-cell">${Object.values(inspectorShopCounts).reduce((a,b)=>a+b,0)}</td>
            <td class="stats-total-cell">${Object.values(morningCounts).reduce((a,b)=>a+b,0)}</td>
            <td class="stats-total-cell">${Object.values(eveningCounts).reduce((a,b)=>a+b,0)}</td>
            <td class="stats-total-cell">${Object.values(weekendCounts).reduce((a,b)=>a+b,0)}</td>
          </tr>
        </tfoot>
      </table>`;
      document.getElementById("stats").innerHTML = html;
    }

    // جدول الخطة (لجميع المستخدمين)
    function renderPlanTable() {
      let html = `<table>
        <thead>
          <tr>
            <th>اسم المفتش</th>
            <th>اليوم</th>
            <th>وقت المناوبة</th>
            <th>المنطقة</th>
            <th>المحلات</th>
          </tr>
        </thead>
        <tbody>
      `;
      (planData.distribution||[]).forEach((row, idx) => {
        html += `<tr>
          <td>${row.inspector}</td>
          <td>${row.day}</td>
          <td>${row.shift || ""}</td>
          <td>${row.area}</td>
          <td>
            <button class="shops-cell-btn" onclick="showShopListPopup(${idx})">عرض المحلات</button>
          </td>
        </tr>`;
      });
      html += `</tbody>
        <tfoot>
          <tr>
            <td class="goals-cell" colspan="5">
              <span class="goals-red">أهداف التفتيش هذا الشهر:</span><br>
              <span>${(planData.goals||"" ).replace(/\n/g, "<br>")}</span>
            </td>
          </tr>
        </tfoot>
      </table>`;
      document.getElementById("planTable").innerHTML = html;
    }

    // حفظ الأهداف
    function saveGoals() {
      let newGoals = document.getElementById("goalsEdit").value.trim();
      if (newGoals) {
        planData.goals = newGoals;
        renderPlanTable();
        renderStats();
        alert("تم حفظ أهداف التفتيش محليًا. اضغط حفظ الخطة لحفظها نهائيًا على GitHub.");
      }
    }

    // حفظ الخطة على GitHub (للمطور فقط)
    async function savePlan() {
      if(!isDevAuthorized) return alert("صلاحية مطور مطلوبة");
      let token = getTokenOrAsk();
      if(!token) return alert("يجب إدخال التوكن أولاً");
      // جلب sha الحالي للملف
      let apiUrl = `https://api.github.com/repos/${PLAN_REPO}/contents/${PLAN_FILE}`;
      let resp = await fetch(apiUrl, {headers:{Authorization: "token "+token}});
      if(!resp.ok) return alert("فشل جلب بيانات الملف من GitHub (تحقق من التوكن)");
      let fileJson = await resp.json();
      let sha = fileJson.sha;
      // رفع التحديث
      let planContent = JSON.stringify(planData, null, 2);
      let updateResp = await fetch(apiUrl, {
        method:"PUT",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"token "+token
        },
        body: JSON.stringify({
          message: "تحديث خطة التفتيش من الواجهة التفاعلية",
          content: btoa(unescape(encodeURIComponent(planContent))),
          sha: sha,
          branch: PLAN_BRANCH
        })
      });
      if(updateResp.ok) {
        alert("تم حفظ الخطة على GitHub بنجاح!");
        reloadPlan(true);
      } else {
        let e = await updateResp.json();
        alert("فشل حفظ الخطة:\n"+(e.message||""));
      }
    }
    // حفظ الخطة على الجهاز (للمطور)
    function savePlanLocally() {
      let plan = planData;
      let blob = new Blob([JSON.stringify(plan, null, 2)], {type:"application/json"});
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = "plan-data.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert("تم حفظ الخطة على جهازك!");
    }

    // نسخة احتياطية تلقائية (للمطور)
    setInterval(()=>{
      if(isDevAuthorized && planData)
        localStorage.setItem("planDataBackup", JSON.stringify(planData));
    }, 10000);

  </script>
</body>
</html>
